---
title: "Notion へ保存した画像に API を使って OCR をかけて検索性を高める"
emoji: "🔎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["notion", "notionapi", "gas"]
published: true
---
# モチベーション

Web ブラウジングしながら、気になったページを Notion へ放り込んでいる。それも毎日のように。

最近は Twitter 用として OGP 画像が増えてきてるが、字数の問題からか OGP 画像だけにとどまらずちょっと込み入った内容は画像をアップするケースが多くなってきてる感じがする。
もちろん Twitter だけに限らず、Web では上手に図解されて説明された有意義な資料も多い。

また、スマートフォンにおいてはテキストをコピペして保存するより、画面のスクリーンショットを撮ってその画像をそのまま保存するほうが手っ取り早い。

それら Notion に溜まった画像を OCR 処理して検索対象にできると、検索性が高まり一層 Notion の活用の幅が広がってくる。

# 想定読者

想定している読者は、下記の想定です。

 * Notion API に興味がある
 * Notion に画像がたくさん溜まってる

:::message
読みすすめて OCR 化できるようになるには、下記の前提も必要となります。

 * Notion の Token 取得方法がわかる
 * GAS でコードを書いてトリガを使ったことがある
 * GAS で標準機能以外の API を追加したことがある

 ですが、Notion についてはプログラムに明るくない人達の利用も多そうですので、参考資料も追加してます。 不明な点は `詳細` を開いて確認したり、 Twitter などで質問ください。
:::

# Notion API のアップデート

５月に待望の API 開放が発表されました。
そのタイミングで Notion と Google Calendar を連携できるようになったのがすごく嬉しかったので、舞い上がった勢いのまま以下の本を書いてます（ここで一旦コマーシャルです）。

https://zenn.dev/nobu/books/215bd245509974

ですが、このタイミングでは、まだ画像が取得出来ないという制限がありました。

そこから３ヶ月経過し、先日のアップデートでようやく念願の画像の取得がサポートされました。Good Job 🎉。

https://developers.notion.com/changelog/page-icons-cover-images-new-block-types-and-improved-page-file-properties

API 公開前からずーっと「Notion の画像に OCR をかけたいなー」と思っていましたので、早速試してみてうまくいったので手順を公開します。

![image](/images/notion-ocr-gas/result.png)

# 仕様

仕様というほど大げさなものではないのですが、処理的には GAS を利用して以下の感じにしてみました。

1. OCR Text が未入力の Page を検索
1. 検索された Page から全 Block を取得
1. 画像の Block から URL を抽出
1. 抽出した URL で画像を GoogleDrive へダウンロード
1. GoogleDrive で OCR をかける
1. Page に OCR Text を入力

OCR Text は Page の Property に仕込んでます。

:::message
本当は Toggle リストとして本文に追加した上で隠したかったのですが、下記の理由から見送ってます。

* 現時点での API 仕様では Blocks は追加のみで、削除することが出来ない
 （ということは更新できない）
* Toggle ではなく Text にもできるが、更新がちょっと複雑になる
 （ということはバグに繋がる可能性が高い）

Property も非表示にすることは出来ますので、まあ、当初の目的は達成です。
:::

:::message alert
ですが、Property にしたことで弊害もあります。Peoperty の場合は字数制限があり、最大で 2,000 文字までしか登録できないようです。ここは諦めましょう。
:::

# 準備

GAS でコードを書く前に、Notion API を利用するには Token が必要です。事前に設定しておいてください。また、当然ながら対象となるデータベースの ID も必要です。

:::details 詳細
下記のページを参考にして `notionToken` と `notionDbId` を準備してください。

https://zenn.dev/nobu/books/215bd245509974/viewer/65485b
:::

準備が出来ましたら、新しい GAS ファイルを作成します。

:::details 詳細
ここからは下記ページを参考にしてください。

https://zenn.dev/nobu/books/215bd245509974/viewer/d2abc2
:::

実際のコードは以下になります。

@[gist](https://gist.github.com/nobuhito/a8d3871af83a3fb407a4adeb906aab56)

取得済みの `notionToken` と `notionDbId` を反映させてください。

また、`ocrProperty` も必要に応じて変更してください。OCR Text が入る Property ですが、使ってないようであればこのままで構いません。

最後に、今回のコードでは標準機能以外の DriveAPI を利用していますので追加してください。

:::details 詳細
DriveAPI は下記画面のように追加してください。サービスの「＋」をクリックすると選択できます。

![image](/images/notion-ocr-gas/drive-api.png)
:::

# 運用

これで準備は完了しましたので、いよいよ実行してみます。
エディタの `実行` ボタンをクリックすると、OCR 処理されていない最新の 50 件を対象に OCR 処理が走るはずです。なお、1 回目だけは承認画面が出てくるはずですので、理解した上で実行してください。

毎回エディタから `実行` させても良いですが、 GAS のトリガー機能を利用して定期的に実行すると良いでしょう。

:::details 詳細
下記ページを参考に、 `時間主導型` のトリガーを作成します。
https://tonari-it.com/gas-timed-driven-trigger/
:::

これで任意のタイミングで自動的に OCR 化されるはずです。
毎回 50 件毎の処理になってますが、これは GAS の実行時間制限に引っかからないようするためです。50 件以上でも問題ないはずですが、50 件づつでもいつかは処理が終わる仕様になってます。

:::message
なお、画像がない場合は `no-image` がセットされます。もし画像を追加した場合や差し替えた場合は、 Property の値を空にしてください。次回の OCR 化対象ページとなります。
:::

# 注意

Notion 純正の WebClipper はちょっと気が利いていないので、 Save to Notion を利用している人も多いでしょう。僕もその一人です。
https://chrome.google.com/webstore/detail/save-to-notion/ldmmifpegigmeammaeckplhnjbbpccmm

ですが、この拡張機能は公式の API が発表されてないときからのもので、まだ非公式 API を使ってるところが多そうです。

:::message
その関係だと思われるのですが、この拡張機能で自動的に書き込まれる画像については、そのままでは公式 API から取得できないようです。公式 API を利用すれば内部的にインデックスが作られるところ、非公式の場合はインデックスが作られないという感じでしょうかね。
:::

ページを開いて画像を移動させるだけで公式 API からも取得できるようになりますので、拡張機能が公式 API をサポートするまではなんとかやりくりする必要があります。

一度すべてに対して OCR 処理を実施し、ギャラリー表示で画像が表示されるのに `no-image` になってるものを手動で調整という感じが良さそうです。

# コンクルージョン

最初の API 公開から３ヶ月、ようやく実用的になってきた感じ。

一時はみんながあんなに API API 言ってたのに、最近は Google 含めてあまり面白い API 公開がなくなってきた気がする。

そんな中、一般ユーザー向けサービスであろう Notion が着実に API を進化させてるのは、実用的な面でも意気込み的な面でも大変素晴らしい。
ほんと、こんなに良いものを無料で使い続けて良いのかと、逆に申し訳なくなるレベル。
（Zenn で売上が上がったら課金したいですね✨）

今後もウォッチ続けて面白い使い方を考えていきたいところ。

とりあえず、Notion の公式 API だけを使った WebClipper を作りたい欲が高まってきた。